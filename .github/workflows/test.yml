name: Tests

on:
  pull_request:
    branches: ['*']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Cache USearch build
        id: cache-usearch
        uses: actions/cache@v4
        with:
          path: /tmp/usearch
          key: ${{ runner.os }}-usearch-v2.16.6-${{ hashFiles('.github/workflows/test.yml') }}

      - name: Build USearch
        if: ${{ steps.cache-usearch.outputs.cache-hit != 'true' }}
        run: |
          git clone --depth 1 --recursive --branch v2.16.6 https://github.com/unum-cloud/usearch.git
          cd usearch
          export CMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake -D CMAKE_BUILD_TYPE=Release -D USEARCH_USE_FP16LIB=1 -D USEARCH_USE_OPENMP=0 -D USEARCH_USE_SIMSIMD=0 -D USEARCH_USE_JEMALLOC=1 -D USEARCH_BUILD_TEST_CPP=1 -D USEARCH_BUILD_BENCH_CPP=1 -D USEARCH_BUILD_LIB_C=1 -D USEARCH_BUILD_TEST_C=1 -D USEARCH_BUILD_SQLITE=0 -B build_release
          cmake --build build_release --config Release
        working-directory: /tmp

      - name: Copy USearch Library and Headers
        run: |
          cp /tmp/usearch/build_release/libusearch_static_c.a libusearch_c.a
          sudo mkdir -p /usr/local/include
          sudo cp /tmp/usearch/c/usearch.h /usr/local/include/

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run Frontend Tests
        run: |
          bun install
          bun run test:unit --run
        working-directory: frontend

      - name: Run Go Tests
        env:
          CGO_ENABLED: 1
          CGO_LDFLAGS: "-L. libusearch_c.a -lstdc++ -lm"
        run: |
          go test -timeout 5m ./...
